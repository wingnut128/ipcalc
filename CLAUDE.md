# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Personality

You are a professional Rust developer. Write idiomatic, safe Rust. Favor clarity over cleverness. Use standard library types and traits where possible. Follow Rust API guidelines and community conventions.

## Git Commit Rules

- Do NOT append "Co-Authored-By" lines to commit messages.
- Do NOT include "Generated by" or "Authored by" lines in commit messages or PR descriptions.
- Write concise, conventional commit messages (e.g., `fix:`, `feat:`, `refactor:`, `docs:`, `test:`).

## Security Filters

NEVER read, write, edit, list, display, copy, move, or otherwise access the following:

- `~/.ssh/` or any `.ssh/` directory and its contents (keys, config, known_hosts, etc.)
- `.env`, `.env.*`, `*.env` files (e.g., `.env.local`, `.env.production`, `prod.env`)
- `credentials.json`, `service-account*.json`, `*-credentials.*`
- `*.pem`, `*.key`, `*.p12`, `*.pfx`, `*.jks` (private keys and keystores)
- `~/.aws/`, `~/.config/gcloud/`, `~/.azure/` (cloud provider credentials)
- `~/.gnupg/` (GPG keys)
- `*secret*`, `*token*` files (unless they are clearly source code, e.g., `token.rs`)
- `~/.netrc`, `~/.npmrc` with auth tokens, `~/.docker/config.json`

If the user asks you to access any of these, refuse and explain why.

## Workflow

When working on a Linear ticket:

1. Create a GitHub issue that references the Linear ticket ID (e.g., "Linear Ticket: BEA-XX") in the issue body
2. Open a feature branch for the work
3. Implement, commit, and push the branch
4. Update `CHANGELOG.md` with the changes (add to `[Unreleased]` or a new version section as appropriate)
5. Update `README.md` when changes affect user-facing behavior: new features, changed commands, new build targets, deprecations, or removed functionality
6. Create a PR — branch protection requires all changes go through a pull request (you cannot push directly to main)
7. After CI passes, merge the PR and clean up the branch (local + remote, prune stale refs)

### Post-commit documentation rules

After every commit (whether from a Linear ticket or not):

- **CHANGELOG.md**: Always add an entry under `[Unreleased]` for any meaningful change (features, fixes, refactors, CI changes, dependency updates). Only skip for typo fixes or whitespace-only changes.
- **README.md**: Update whenever there are important changes to the codebase — new or changed CLI commands, new build/make targets, new features, deprecation warnings, removed functionality, or changes to setup/install instructions. Do not update README for purely internal refactors or CI-only changes unless they affect the developer workflow (e.g., new `make` targets).

## Release Process

Releases use a `workflow_dispatch` GitHub Actions workflow to respect branch protection on `main`.

1. Create a PR that bumps the `version` in `Cargo.toml` and moves `[Unreleased]` entries to a new `[X.Y.Z]` section in `CHANGELOG.md`
2. Merge the PR through normal review/CI
3. Go to **Actions → Release → Run workflow** and enter the version (e.g. `0.12.0`, no leading `v`)
4. The workflow validates `Cargo.toml` version matches, confirms a CHANGELOG entry exists, extracts release notes, creates a GitHub release with tag `vX.Y.Z`, and builds/uploads cross-platform binaries

## Build & Development Commands

```bash
# Essential commands
make check          # Run fmt-check, lint, test, test-tui, test-mcp, and semgrep (use before commits)
make test           # Run all tests
make test-tui       # Run TUI tests (requires tui feature)
make lint           # Run clippy with -D warnings
make fmt            # Format code

# Build
make build          # Debug build
make release        # Release build
cargo install --path .  # Install binary locally

# Run single test
cargo test test_name

# API server
make serve          # Run on localhost:8080
make serve-debug    # Run with debug logging

# API server with config file and overrides
ipcalc serve --config ipcalc.toml
ipcalc serve --enable-swagger --max-batch-size 500 --timeout 60

# Fuzz testing (requires: rustup toolchain install nightly && cargo install cargo-fuzz)
make fuzz                                      # Run fuzz_cidr_parsing for 60s
make fuzz FUZZ_TARGET=fuzz_contains FUZZ_DURATION=30  # Run specific target

# CLI usage
ipcalc v4 192.168.1.0/24              # IPv4 subnet info
ipcalc v6 2001:db8::/48               # IPv6 prefix info
ipcalc split 10.0.0.0/8 -p 16 -n 10   # Generate 10 /16 subnets
ipcalc split 10.0.0.0/8 -p 16 --max   # Generate all possible /16 subnets
```

Global options: `--format json|text|csv|yaml`, `--output <file>`

**Important**: Run `make setup` after cloning to install git hooks that enforce formatting and linting on commits.

## Architecture

This is a Rust CLI/API for IPv4 and IPv6 subnet calculations.

**Core flow**: CLI (`main.rs`) parses args via clap (`cli.rs`) → routes to calculation modules (`ipv4.rs`, `ipv6.rs`, `subnet_generator.rs`) → formats output (`output.rs`).

**Key modules**:
- `ipv4.rs` / `ipv6.rs` - Subnet calculation logic using bitwise operations (u32/u128)
- `subnet_generator.rs` - Splits supernets into smaller subnets (supports `--count` or `--max`)
- `api.rs` - Axum HTTP server with 6 endpoints sharing the same data structures as CLI
- `error.rs` - Custom `IpCalcError` enum with `Result<T>` type alias used throughout
- `output.rs` - `TextOutput` trait for JSON/text formatting

**Data structures** (`Ipv4Subnet`, `Ipv6Subnet`) are serializable and shared between CLI and API.

## Code Patterns

- Error handling: `thiserror` derive macros, all functions return `Result<T>`
- Logging: `tracing` with `#[instrument]` on API handlers
- CLI: clap derive with subcommands (`v4`, `v6`, `split`, `serve`)
- Tests: Unit tests in modules, integration tests in `tests/` call binary via subprocess
